<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    const firebaseConfig = {
        apiKey: "AIzaSyB0luDWLYVo32_4sb-CZBMbzQhfOXGaWQI",
        authDomain: "amigosecreto-6f612.firebaseapp.com",
        projectId: "amigosecreto-6f612",
        storageBucket: "amigosecreto-6f612.firebasestorage.app",
        messagingSenderId: "451995498899",
        appId: "1:451995498899:web:038e98ff1742ff581d9066",
        measurementId: "G-8X7LQ4HH6K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const names = ["Mayane", "Fernanda", "Alexsandro", "Jalon", "Ary", "Bernardo", "Emanuelle", "Bruno"];

    function normalizeName(inputName) {
        return inputName.trim().toUpperCase();
    }

    async function saveResult(userName, drawnName) {
        try {
            await setDoc(doc(db, 'sorteios', userName), { sorteio: drawnName });
        } catch (error) {
            console.error("Erro ao salvar resultado no Firestore:", error);
        }
    }

    async function getResult(userName) {
        try {
            const docRef = doc(db, 'sorteios', userName);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                return docSnap.data().sorteio;
            } else {
                return null;
            }
        } catch (error) {
            console.error("Erro ao buscar sorteio no Firestore:", error);
            return null;
        }
    }

    async function startDraw() {
        const userNameInput = document.getElementById("userName").value;
        const userName = normalizeName(userNameInput);

        if (!userName) {
            alert("Por favor, insira seu nome.");
            return;
        }

        const savedResult = await getResult(userName);
        if (savedResult) {
            document.getElementById("result").innerHTML = `<strong>Você já sorteou: ${savedResult}!</strong>`;
            document.getElementById("drawButton").disabled = true;
            return;
        }

        const filteredNames = names.filter(name => normalizeName(name) !== userName);

        if (filteredNames.length === 0) {
            document.getElementById("result").innerText = "Não há mais nomes para sortear.";
            return;
        }

        const randomIndex = Math.floor(Math.random() * filteredNames.length);
        const drawnName = filteredNames[randomIndex];

        await saveResult(userName, drawnName);
        document.getElementById("result").innerHTML = `<strong>Você tirou: ${drawnName}!</strong>`;
        document.getElementById("drawButton").disabled = true;
    }

    async function resetFirestore() {
        const collectionRef = collection(db, 'sorteios');
        const querySnapshot = await getDocs(collectionRef);

        querySnapshot.forEach(async (docSnap) => {
            await deleteDoc(doc(db, 'sorteios', docSnap.id));
        });

        alert("Sorteio resetado com sucesso!");
        document.getElementById("result").innerHTML = "";
        document.getElementById("drawButton").disabled = false; // Reabilitar o botão de sorteio após reset
    }

    document.addEventListener('DOMContentLoaded', () => {
        const drawButton = document.getElementById("drawButton");
        const resetButton = document.getElementById("resetButton");

        // Verificar se o botão de sorteio está disponível
        if (drawButton) {
            drawButton.addEventListener("click", startDraw);
        }

        // Verificar se o botão de reset está disponível
        if (resetButton) {
            resetButton.addEventListener("click", async () => {
                const password = prompt("Digite a senha para resetar o sorteio:");
                if (password === "minhaSenha123") {
                    await resetFirestore();
                } else {
                    alert("Senha incorreta. Acesso negado.");
                }
            });

            // Definir o botão de reset como escondido ao carregar a página
            resetButton.style.display = "none";
        }

        // Lógica para exibir ou ocultar o botão de reset conforme necessário
        setTimeout(() => {
            if (resetButton && drawButton) {
                resetButton.style.display = "inline-block"; // Mostrar o botão de reset após algum tempo (opcional)
            }
        }, 1000); // Exemplo: 1 segundo após a página carregar
    });
</script>
