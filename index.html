<script type="module">
    // Importando módulos do Firebase via CDN
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // Configuração do Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyB0luDWLYVo32_4sb-CZBMbzQhfOXGaWQI",
        authDomain: "amigosecreto-6f612.firebaseapp.com",
        projectId: "amigosecreto-6f612",
        storageBucket: "amigosecreto-6f612.firebasestorage.app",
        messagingSenderId: "451995498899",
        appId: "1:451995498899:web:038e98ff1742ff581d9066",
        measurementId: "G-8X7LQ4HH6K"
    };

    // Inicializando o Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Lista de nomes para o sorteio
    const names = ["Mayane", "Fernanda", "Alexsandro", "Jalon", "Ary", "Bernardo", "Emanuelle", "Bruno"];

    // Função para normalizar os nomes
    function normalizeName(inputName) {
        return inputName.trim().toUpperCase();
    }

    // Função para salvar o resultado no Firestore
    async function saveResult(userName, drawnName) {
        try {
            await setDoc(doc(db, 'sorteios', userName), { sorteio: drawnName });
            localStorage.setItem(userName, drawnName); // Salva no Local Storage
        } catch (error) {
            console.error("Erro ao salvar resultado no Firestore:", error);
        }
    }

    // Função para recuperar o sorteio do Firestore
    async function getResult(userName) {
        try {
            const localResult = localStorage.getItem(userName);
            if (localResult) {
                return localResult;
            }
            const docRef = doc(db, 'sorteios', userName);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                return docSnap.data().sorteio;
            } else {
                return null;
            }
        } catch (error) {
            console.error("Erro ao buscar sorteio no Firestore:", error);
            return null;
        }
    }

    // Função principal do sorteio
    async function startDraw() {
        const userNameInput = document.getElementById("userName").value;
        const userName = normalizeName(userNameInput);

        if (!userName) {
            alert("Por favor, insira seu nome.");
            return;
        }

        // Verificar se o resultado já foi sorteado para o usuário (Local Storage + Firestore)
        const savedResult = await getResult(userName);
        if (savedResult) {
            document.getElementById("result").innerHTML = `<strong>Você já sorteou: ${savedResult}!</strong>`;
            document.getElementById("drawButton").disabled = true;
            return;
        }

        // Filtra os nomes para garantir que o usuário não sorteie a si mesmo
        const filteredNames = names.filter(name => normalizeName(name) !== userName);

        if (filteredNames.length === 0) {
            document.getElementById("result").innerText = "Não há mais nomes para sortear.";
            return;
        }

        // Sorteio aleatório
        const randomIndex = Math.floor(Math.random() * filteredNames.length);
        const drawnName = filteredNames[randomIndex];

        // Salvar o resultado no Firestore e Local Storage
        await saveResult(userName, drawnName);

        // Mostrar o resultado do sorteio
        document.getElementById("result").innerHTML = `<strong>Você tirou: ${drawnName}!</strong>`;
        document.getElementById("drawButton").disabled = true;
    }

    // Aguardando o carregamento completo do DOM
    document.addEventListener('DOMContentLoaded', async () => {
        const drawButton = document.getElementById("drawButton");
        drawButton.addEventListener("click", startDraw);

        // Verifica no Local Storage se já existe um sorteio
        const userNameInput = document.getElementById("userName");
        userNameInput.addEventListener("input", async () => {
            const userName = normalizeName(userNameInput.value);
            const savedResult = localStorage.getItem(userName);
            if (savedResult) {
                document.getElementById("result").innerHTML = `<strong>Você já sorteou: ${savedResult}!</strong>`;
                drawButton.disabled = true;
            } else {
                drawButton.disabled = false;
                document.getElementById("result").innerHTML = "";
            }
        });
    });
</script>
