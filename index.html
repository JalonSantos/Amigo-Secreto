<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    const firebaseConfig = {
        apiKey: "AIzaSyB0luDWLYVo32_4sb-CZBMbzQhfOXGaWQI",
        authDomain: "amigosecreto-6f612.firebaseapp.com",
        projectId: "amigosecreto-6f612",
        storageBucket: "amigosecreto-6f612.firebasestorage.app",
        messagingSenderId: "451995498899",
        appId: "1:451995498899:web:038e98ff1742ff581d9066",
        measurementId: "G-8X7LQ4HH6K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const names = ["Mayane", "Fernanda", "Alexsandro", "Jalon", "Ary", "Bernardo", "Emanuelle", "Bruno"];

    function normalizeName(inputName) {
        return inputName.trim().toUpperCase();
    }

    async function saveResult(userName, drawnName) {
        try {
            await setDoc(doc(db, 'sorteios', userName), { sorteio: drawnName });
            localStorage.setItem('amigoSecreto', JSON.stringify({ userName, drawnName }));
        } catch (error) {
            console.error("Erro ao salvar no Firestore:", error);
        }
    }

    async function getResult(userName) {
        try {
            const docRef = doc(db, 'sorteios', userName);
            const docSnap = await getDoc(docRef);
            return docSnap.exists() ? docSnap.data().sorteio : null;
        } catch (error) {
            console.error("Erro ao buscar sorteio:", error);
            return null;
        }
    }

    async function startDraw() {
        const userNameInput = document.getElementById("userName").value;
        const userName = normalizeName(userNameInput);

        if (!userName) {
            alert("Por favor, insira seu nome.");
            return;
        }

        const savedResult = await getResult(userName);
        if (savedResult) {
            document.getElementById("result").innerHTML = `<strong>Você já sorteou: ${savedResult}!</strong>`;
            document.getElementById("drawButton").disabled = true;
            return;
        }

        const filteredNames = names.filter(name => normalizeName(name) !== userName);
        if (filteredNames.length === 0) {
            document.getElementById("result").innerText = "Não há mais nomes para sortear.";
            return;
        }

        const randomIndex = Math.floor(Math.random() * filteredNames.length);
        const drawnName = filteredNames[randomIndex];

        await saveResult(userName, drawnName);

        document.getElementById("result").innerHTML = `<strong>Você tirou: ${drawnName}!</strong>`;
        document.getElementById("drawButton").disabled = true;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const drawButton = document.getElementById("drawButton");
        const storedData = JSON.parse(localStorage.getItem('amigoSecreto'));

        if (storedData && storedData.userName) {
            document.getElementById("userName").value = storedData.userName;
            document.getElementById("result").innerHTML = `<strong>Você tirou: ${storedData.drawnName}!</strong>`;
            drawButton.disabled = true;
        } else {
            drawButton.addEventListener("click", startDraw);
        }
    });
</script>
