<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amigo Secreto</title>
    <style>
        /* Adicione seu estilo aqui */
    </style>
</head>
<body>
    <div class="container">
        <h1>Bem-vindo ao Amigo Secreto!</h1>
        <p>Insira seu nome e senha para participar do sorteio.</p>

        <!-- Passo 1: Nome -->
        <div id="nameInput">
            <input type="text" id="userName" placeholder="Digite seu nome aqui">
            <button id="nextButton">Próximo</button>
        </div>

        <!-- Passo 2: Criar ou inserir senha -->
        <div id="passwordInput" style="display: none;">
            <input type="password" id="password" placeholder="Crie ou insira sua senha">
            <button id="startDraw" disabled>Sortear</button>
        </div>

        <div class="result" id="result"></div>
    </div>

    <!-- Importando o Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.17.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.0/firebase-firestore.js"></script>

    <script type="module">
        // Sua configuração do Firebase
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_AUTH_DOMAIN",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_STORAGE_BUCKET",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        // Inicializando o Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);

        const names = ["Mayane", "Fernanda", "Alexsandro", "Jalon", "Ary", "Bernardo", "Emanuelle", "Bruno"];
        
        function normalizeName(inputName) {
            return inputName.trim().toUpperCase();
        }

        async function startDraw(userName, password) {
            const userRef = db.collection('users').doc(userName);
            const userDoc = await userRef.get();

            if (!userDoc.exists) {
                alert("Usuário não encontrado. Tente novamente.");
                return;
            }

            const storedPassword = userDoc.data().password;
            if (storedPassword !== password) {
                alert("Senha incorreta.");
                return;
            }

            const filteredNames = names.filter(name => normalizeName(name) !== userName);
            if (filteredNames.length === 0) {
                document.getElementById("result").innerText = "Não há mais nomes para sortear.";
                return;
            }

            const randomIndex = Math.floor(Math.random() * filteredNames.length);
            const drawnName = filteredNames[randomIndex];

            // Salvar o resultado do sorteio no Firestore
            await userRef.update({
                drawnName: drawnName
            });

            document.getElementById("result").innerHTML = `<strong>Você tirou: ${drawnName}!</strong>`;
        }

        async function createAccount(userName, password) {
            const userRef = db.collection('users').doc(userName);
            const userDoc = await userRef.get();

            if (userDoc.exists) {
                alert("Nome já registrado. Tente fazer login.");
                return;
            }

            await userRef.set({
                password: password,
                name: userName
            });

            startDraw(userName, password);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const userNameInput = document.getElementById("userName");
            const passwordInput = document.getElementById("password");
            const nextButton = document.getElementById("nextButton");
            const startDrawButton = document.getElementById("startDraw");

            // Passo 1: Nome
            nextButton.addEventListener("click", async () => {
                const userName = normalizeName(userNameInput.value);
                if (!userName) {
                    alert("Por favor, insira seu nome.");
                    return;
                }

                // Verificar se o nome já existe no Firestore
                const userRef = db.collection('users').doc(userName);
                const userDoc = await userRef.get();

                // Se já tiver usuário, pedir senha para login
                if (userDoc.exists) {
                    document.getElementById("nameInput").style.display = "none";
                    document.getElementById("passwordInput").style.display = "block";
                    document.getElementById("startDraw").disabled = false;
                    passwordInput.placeholder = "Insira sua senha";
                } else {
                    // Se não, permitir criação de senha
                    document.getElementById("nameInput").style.display = "none";
                    document.getElementById("passwordInput").style.display = "block";
                    document.getElementById("startDraw").disabled = false;
                    passwordInput.placeholder = "Crie uma senha";
                }
            });

            // Passo 2: Criar ou inserir senha e iniciar sorteio
            startDrawButton.addEventListener("click", () => {
                const userName = normalizeName(userNameInput.value);
                const password = passwordInput.value;
                if (!password) {
                    alert("Por favor, insira uma senha.");
                    return;
                }

                const userRef = db.collection('users').doc(userName);
                userRef.get().then((userDoc) => {
                    if (userDoc.exists) {
                        // Se o usuário já existir, faz o login e sorteio
                        startDraw(userName, password);
                    } else {
                        // Se não existir, cria uma nova conta
                        createAccount(userName, password);
                    }
                });
            });
        });
    </script>
</body>
</html>
